import pyodbc
import sys
import os
import json
import csv

server='virtualsignlanguage.database.windows.net'
database='virtualsignlanguage'
username='vsladmin'
password='Ingarage#2020'
cnxn = pyodbc.connect('DRIVER={ODBC Driver 17 for SQL Server};SERVER='+server+';DATABASE='+database+';UID='+username+';PWD='+ password)
cursor = cnxn.cursor()
all_id = []
folder = sys.argv[1]

for files in sorted(os.listdir(folder)):
    word_id = None
    word = files.split("_")[0]
    find_id = "SELECT Word_ID FROM [dbo].[WordAlex] Where Word = ?"
    result = cursor.execute(find_id, word)
    for i in result:
        word_id = i[0]
    if word_id == None:
        insert_word = f"INSERT INTO [dbo].[WordAlex] (Word) OUTPUT inserted.Word_ID VALUES(?)"
        raw_id = cursor.execute(insert_word,word)
        for i in raw_id:
            word_id = i.Word_ID
        cnxn.commit()
    all_id.append(word_id)
    frame = files.split("_")[1].split(".")[0]
    if frame == str(0):
        continue
    delete_frame = "DELETE FROM [dbo].[FrameAlex] Where Word_ID = ?"
    cursor.execute(delete_frame,word_id)
    delete_keypoint = "DELETE FROM [dbo].[FullPoseFacialAlex] Where Word_ID = ?"
    cursor.execute(delete_keypoint,word_id)
    # check_frame = "SELECT TOP(1) Video_frame FROM [dbo].[FrameAlex] Where Word_ID = ? AND Video_frame = ?"
    # check_result = cursor.execute(check_frame, word_id,frame).fetchone()
    # if check_result:
    #     print("Pass: ", word,word_id)
    #     continue
    print(word,word_id,frame)
    insert_frame = f'INSERT INTO [dbo].[FrameAlex] (Word_ID,Video_Frame,Animation_Frame) VALUES (?,?,?)'
    cursor.execute(insert_frame, word_id,frame,frame)
    w = []
    x = []
    y = []
    z = []
    frame = files.split("_")[1].split(".")[0]
    all_data = []
    all_data.append(int(frame))
    all_data.append(int(word_id))
    with open(folder + "/" + files, encoding='utf8') as csv_file:
        reader = csv.reader(csv_file)
        for row in reader:
            q = row[0].split(" ")
            all_data.append(float(q[0]))
            all_data.append(float(q[1]))
            all_data.append(float(q[2]))
            all_data.append(float(q[3]))
    # many.append(tuple(all_data))
    init_fullpose = "INSERT INTO [dbo].[FullPoseFacialAlex] VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
    # print(tuple(all_data))
    cursor.execute(init_fullpose, tuple(all_data))
cnxn.commit()

with open(f"{sys.argv[2]}.txt","w") as file:
    for id in set(all_id):
        file.write(f"{id},")